# 数据下载指南

## 概述

CoinGuard 项目的数据下载功能已经升级，现在支持详细的进度条显示，让您能够实时监控下载进度。

## 功能特性

### 🚀 增强的进度条显示
- **实时进度**: 显示当前下载进度和预计完成时间
- **下载速度**: 显示实时下载速度
- **详细状态**: 显示当前正在处理的交易对
- **错误统计**: 显示失败的请求数量

### 📊 多阶段进度跟踪
1. **获取交易对列表**: 显示API请求进度
2. **下载K线数据**: 显示每个交易对的下载进度
3. **数据类型转换**: 显示数据处理进度
4. **获取多空比数据**: 分别显示账户和持仓多空比下载进度
5. **保存文件**: 显示文件保存进度

### ⏱️ 时间估算
- 显示已用时间和预计剩余时间
- 显示完成时间戳
- 显示总耗时统计

## 使用方法

### 方法1: 直接运行下载脚本
```bash
cd /Users/lewiszhang/Desktop/CoinGuard
python data/raw/download.py
```

### 方法2: 使用测试脚本
```bash
cd /Users/lewiszhang/Desktop/CoinGuard
python test_download.py
```

### 方法3: 通过主程序运行
```bash
cd /Users/lewiszhang/Desktop/CoinGuard
python run.py --download
```

## 进度条说明

### 进度条格式
```
📊 获取K线数据: 45%|████▌     | 450/1000 [02:15<02:45, 3.3it/s] 当前: BTCUSDT
```

- `📊 获取K线数据`: 当前操作描述
- `45%`: 完成百分比
- `████▌     `: 可视化进度条
- `450/1000`: 已完成/总数
- `[02:15<02:45, 3.3it/s]`: 已用时间<预计剩余时间, 处理速度
- `当前: BTCUSDT`: 当前正在处理的交易对

### 下载进度条格式
```
获取 BTCUSDT K线数据: 100%|██████████| 2.5MB/2.5MB [00:03<00:00, 850KB/s]
```

- 显示文件大小和下载速度
- 实时更新下载进度

## 输出文件

下载完成后，数据将保存到：
- **文件位置**: `data/crypto_klines_data.csv`
- **数据格式**: CSV格式，包含K线数据和多空比数据
- **编码**: UTF-8

## 错误处理

### 失败统计
如果某些交易对的数据获取失败，系统会显示：
```
⚠️  失败统计:
   • K线数据失败: 5 个交易对
   • 账户多空比失败: 3 个交易对
   • 持仓多空比失败: 2 个交易对
```

### 中断处理
- 使用 `Ctrl+C` 可以安全中断下载过程
- 已下载的数据会被保留
- 显示中断时的进度状态

## 性能优化

### 请求限制
- 默认请求间隔: 0.1秒
- 防止API请求过于频繁
- 可配置的延迟时间

### 内存优化
- 流式下载大文件
- 分批处理数据
- 及时释放内存

## 配置选项

可以在 `data/raw/download.py` 中修改以下配置：

```python
# API请求间隔（秒）
REQUEST_DELAY_SECONDS = 0.1

# 输出文件路径
OUTPUT_CSV_FILE = "data/crypto_klines_data.csv"

# 数据限制
limit = 1000  # 每个请求的数据条数
```

## 故障排除

### 常见问题

1. **网络连接问题**
   - 检查网络连接
   - 确认API服务可用性

2. **权限问题**
   - 确保有写入 `data/` 目录的权限
   - 检查文件路径是否正确

3. **内存不足**
   - 减少 `limit` 参数值
   - 增加 `REQUEST_DELAY_SECONDS` 延迟

### 日志信息

下载过程中会显示详细的日志信息：
- ✅ 成功操作
- ❌ 失败操作
- ⚠️ 警告信息
- 📊 统计信息

## 示例输出

```
🚀 开始下载原始数据 - 2024-01-15 14:30:25
============================================================
正在获取所有交易对列表...
获取交易对列表: 100%|██████████| 1.2MB/1.2MB [00:02<00:00, 650KB/s]
✅ 成功获取到 1250 个交易对。

📊 获取K线数据: 100%|██████████| 1250/1250 [15:30<00:00, 1.35it/s]

📈 K线数据获取完成:
   ✅ 成功: 1245 个交易对
   ❌ 失败: 5 个交易对
   失败的交易对: SYMBOL1, SYMBOL2, SYMBOL3, SYMBOL4, SYMBOL5

💾 正在处理 1,245,000 条K线记录...
转换数据格式: 100%|██████████| 转换数据格式

转换数据类型: 100%|██████████| 8/8 处理: volume

📊 正在获取账户多空比数据...
获取账户多空比: 100%|██████████| 1245/1245 [08:15<00:00, 2.5it/s]

📊 正在获取持仓多空比数据...
获取持仓多空比: 100%|██████████| 1245/1245 [08:20<00:00, 2.5it/s]

💾 正在保存数据到文件...
保存CSV文件: 100%|██████████| 保存CSV文件

============================================================
🎉 数据下载完成!
📁 文件保存位置: data/crypto_klines_data.csv
📊 总记录数: 1,245,000 条K线记录
⏱️  总耗时: 0:32:45
🕐 完成时间: 2024-01-15 15:03:10

📈 数据统计:
   • 交易对数量: 1245
   • 时间范围: 1640995200000 - 1705334400000
   • 账户多空比记录: 1,200,000
   • 持仓多空比记录: 1,180,000
============================================================
```
